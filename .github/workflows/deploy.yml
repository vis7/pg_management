name: Deploy to EC2
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: rsync deployments
        uses: burnett01/rsync-deployments@5.1
        with:
          switches: -avzr --delete
          path: ./*
          remote_path: /home/ubuntu/pg_management
          remote_host: ec2-13-233-186-81.ap-south-1.compute.amazonaws.com
          remote_user: ubuntu
          remote_key: "${{secrets.SSH_PRIVATE_KEY}}"
          command: /bin/sh ./deployment.sh

          # - name: Create SSH key
    #   run: |
    #     mkdir -p ~/.ssh/
    #     echo "$SSH_PRIVATE_KEY" > ../private.key
    #     sudo chmod 600 ../private.key
    #     echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    #   shell: bash
    #   env:
    #     SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
    #     SSH_KNOWN_HOSTS: ${{secrets.SSH_KNOWN_HOSTS}}
    #     SSH_KEY_PATH: ${{ github.workspace }}/../private.key

    # - name: deploy new code
    #   run: |
    #     # entering server using ssh
    #     ssh -i $SSH_KEY_PATH user@host

    #     # go to repository and take latest pull from github
    #     # source venv/bin/activate
    #     # cd pg_management/
    #     # git pull origin main

    # - name: Get current date
    #   id: date
    #   run: echo "::set-output name=date::$(date +'%Y%m%d_%H%M%S')"
    #   shell: bash

    # - name: Generate deployment package
    #   run: zip -r deploy.zip . -x '*.git*'

    # - name: Deploy to Elastic Beanstalk
    #   uses: einaregilsson/beanstalk-deploy@v20
    #   with:
    #     aws_access_key: AKIAUVPQX23OEXVLKDVR
    #     aws_secret_key: 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
    #     application_name: prod-testmojo
    #     environment_name: production-testmojo-backend
    #     version_label: ${{ github.sha }}
    #     region: ap-south-1
    #     deployment_package: deploy.zip
    #     wait_for_deployment: false
    #     existing_bucket_name: elasticbeanstalk-ap-south-1-321016813276
